import { Table } from "nextra/components";

# Callbacks

## Overview

Skala allows you to **receive real-time updates** about task status changes by specifying a **callback URL**. When a task is completed, Skala will send a **POST request** to the specified callback URL with the task details in JSON format.

### **How Callbacks Work**

- When creating a task, you can include a `callback_url` parameter.
- Once the task is completed, Skala will **POST** the task's result to the `callback_url`.
- If no callback URL is provided in the request, Skala will use the **default callback URL** from your account settings.
- You can also provide an **email address** as the `callback_url`, in which case Skala will send the task result via email from **hello@skala.xyz**.

---

## Callback Request Format

Skala sends task updates in the following **JSON format**:

```json filename="JSON"
{
  "task": {
    "task_id": "576c41bf13e36b0600b02b34",
    "completed_at": "2016-06-23T21:54:44.904Z",
    "response": {
      "category": "red"
    },
    "created_at": "2016-06-23T20:08:31.573Z",
    "callback_url": "http://www.example.com/callback",
    "type": "categorization",
    "status": "completed",
    "instruction": "Is this object red or blue?",
    "params": {
      "attachment_type": "text",
      "attachment": "tomato",
      "categories": ["red", "blue"]
    },
    "metadata": {}
  },
  "response": {
    "category": "red"
  },
  "task_id": "576c41bf13e36b0600b02b34"
}
```

---

## Callback Response Handling

To acknowledge receipt of a callback, your server should **return a 2xx HTTP status code** (e.g., `200 OK`).

| **Scenario**         | **Action Taken by Skala**                |
| -------------------- | ---------------------------------------- |
| **Receives 2xx**     | No further retries                       |
| **Receives non-2xx** | Retries up to **20 times** over 24 hours |

If Skala **never receives a 2xx response**, the task will be marked with:

```json
"callback_succeeded": false
```

If a **2xx response is received**, the callback is considered successful:

```json
"callback_succeeded": true
```

---

## Getting Started with Callbacks

If you're **testing** and want to experiment with callback requests, here are some easy ways to get started:

- **[RequestBin](https://requestbin.com/)** – Quickly create a test URL to capture webhook events.
- **[Ngrok](https://ngrok.com/)** – Expose a local server to the internet for testing callbacks.
- **[Pipedream](https://pipedream.com/)** – Set up a callback listener and automate responses.

---

## Callback Authentication

To **verify that a callback is from Skala**, each callback request includes an **`skala-callback-auth`** header.

### **Verifying a Callback**

1. Extract the value from the `skala-callback-auth` header.
2. Compare it with your **Live Callback Auth Key** (available in your dashboard).
3. If the values **do not match**, discard the request.

---

## Events That Trigger a Callback

| **Event**                  | **Description**                                                |
| -------------------------- | -------------------------------------------------------------- |
| **Task Completed**         | A task has been successfully completed.                        |
| **Error on Task Creation** | A task failed to be created due to validation errors.          |
| **Audit Status Changed**   | A completed task was **Approved, Rejected, or Fixed**.         |
| **Task Recalled**          | A task was moved from **Completed** to **Pending** for review. |

---

## Callback Payload Structure

<div style={{ marginTop: "1.5rem" }}>
  <Table>
    <thead>
      <Table.Tr>
        <Table.Th>Property</Table.Th>
        <Table.Th>Type</Table.Th>
        <Table.Th>Description</Table.Th>
      </Table.Tr>
    </thead>
    <tbody>
      <Table.Tr>
        <Table.Td>task_id</Table.Td>
        <Table.Td>string</Table.Td>
        <Table.Td>
          The unique identifier for the task. Matches <code>task.task_id</code>.
        </Table.Td>
      </Table.Tr>
      <Table.Tr>
        <Table.Td>status</Table.Td>
        <Table.Td>string</Table.Td>
        <Table.Td>
          The status of the task upon completion. Typically{" "}
          <code>completed</code>, but may be <code>error</code> if it failed.
        </Table.Td>
      </Table.Tr>
      <Table.Tr>
        <Table.Td>response</Table.Td>
        <Table.Td>object</Table.Td>
        <Table.Td>The response object containing the task results.</Table.Td>
      </Table.Tr>
      <Table.Tr>
        <Table.Td>task</Table.Td>
        <Table.Td>object</Table.Td>
        <Table.Td>The full Task Object for reference.</Table.Td>
      </Table.Tr>
    </tbody>
  </Table>
</div>

---

## Re-sending a Callback

If your server **missed a callback** due to downtime or another issue, you can request Skala to **re-send** the original callback.

### **Endpoint**

```sh
POST https://api.skala.xyz/v1/task/{task_id}/send-callback
```

### **Example Request (Python)**

```python filename="Python"

import requests

url = "https://api.skala.xyz/v1/task/taskId/send-callback"

headers = {"accept": "application/json"}

response = requests.post(url, headers=headers)

print(response.text)
```

---

## Best Practices for Handling Callbacks

- **Use a Secure Endpoint** – Always use HTTPS for callback URLs.
- **Verify Authenticity** – Check the `skala-callback-auth` header.
- **Implement Logging** – Log incoming requests to troubleshoot issues.
- **Handle Retries** – Expect duplicate requests and ensure they do not trigger duplicate actions.
- **Keep Callback Processing Fast** – If needed, process callbacks asynchronously to avoid delays.

---

## Summary

| **Feature**                       | **Details**                                                    |
| --------------------------------- | -------------------------------------------------------------- |
| **Callback Mechanism**            | Skala sends POST requests to the `callback_url`.               |
| **Authentication**                | Uses `skala-callback-auth` header for verification.            |
| **Response Handling**             | Must return `2xx` to confirm receipt; otherwise retries occur. |
| **Events that Trigger Callbacks** | Task completion, errors, audits, recalls.                      |
| **Re-sending Callbacks**          | API endpoint available to re-trigger missed callbacks.         |

For additional support, visit our **[API Documentation](https://api.skala.xyz/docs)** or contact **support@skala.xyz**.
